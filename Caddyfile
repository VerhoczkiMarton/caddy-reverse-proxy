# global options
{
    admin off
    persist_config off
    auto_https off
    log {
        format json
    }
    servers {
        trusted_proxies static private_ranges
    }
}

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

:{$PORT} {
    log {
        format json
    }

    # Handle API requests first
    handle /api/* {
        reverse_proxy {
            to {$BACKEND_DOMAIN}:{$BACKEND_PORT}
            import lb_settings
            import passive_health_checks
        }
    }

    # Handle all other requests (frontend)
    handle {
        reverse_proxy {
            to {$FRONTEND_DOMAIN}:{$FRONTEND_PORT}
            import lb_settings
            import passive_health_checks
        }
    }
}
